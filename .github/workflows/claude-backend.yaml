name: Trigger Claude Code

on:
  workflow_dispatch:
    inputs:
      repo_name:
        required: true
        description: "The name of the repo to pull code from"
      command:
        required: true
        description: "The command to run"
      run_id:
        required: false
        description: "Port action run ID to update"

permissions:
  contents: write
  packages: write
        
jobs:
  claude-generic:
    env:
      GITHUB_TOKEN: ${{ secrets.PORT_GITHUB_TOKEN }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PORT_GITHUB_TOKEN }}
          repository: ${{ inputs.repo_name }}
          ref: main

      - name: Configure Git 
        run: |
          git config --global user.name bermanguy
          git config --global user.email guyb@port.io

      - name: Execute Claude Code
        id: claude_execution
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          allowed_tools: "Bash,Edit,Write,GlobTool,GrepTool,BatchTool"
          system_prompt: |
            You are a senior backend engineer. Focus on security, performance, and maintainability.
            You will receive repository and a command. You will follow the commands, and open a PR if relevant.
            Do NOT make any changes directly to main EVER, only through a PR via a new branch.
          prompt: ${{ inputs.command }}

      - name: Parse Claude Code Execution Results
        id: parse_results
        run: |
          # Get the execution file path from the claude_execution step
          EXECUTION_FILE="${{ steps.claude_execution.outputs.execution_file }}"
          
          if [ -f "$EXECUTION_FILE" ]; then
            # Parse the execution results
            RESULT=$(cat "$EXECUTION_FILE" | jq -r '.[] | select(.type == "result") | .')
            
            if [ "$RESULT" != "" ]; then
              # Extract key metrics
              CONCLUSION=$(echo "$RESULT" | jq -r '.subtype // "unknown"')
              DURATION_MS=$(echo "$RESULT" | jq -r '.duration_ms // 0')
              INPUT_TOKENS=$(echo "$RESULT" | jq -r '.usage.input_tokens // 0')
              OUTPUT_TOKENS=$(echo "$RESULT" | jq -r '.usage.output_tokens // 0')
              TOTAL_COST=$(echo "$RESULT" | jq -r '.total_cost_usd // 0')
              SESSION_ID=$(echo "$RESULT" | jq -r '.session_id // ""')
              CLAUDE_RESPONSE=$(echo "$RESULT" | jq -r '.result // ""')
              
              # Set outputs for next steps
              {
                echo "claude_response<<EOF"
                echo "$CLAUDE_RESPONSE"
                echo "EOF"
              } >> $GITHUB_OUTPUT
              echo "conclusion=$CONCLUSION" >> $GITHUB_OUTPUT
              echo "duration_ms=$DURATION_MS" >> $GITHUB_OUTPUT
              echo "input_tokens=$INPUT_TOKENS" >> $GITHUB_OUTPUT
              echo "output_tokens=$OUTPUT_TOKENS" >> $GITHUB_OUTPUT
              echo "total_cost=$TOTAL_COST" >> $GITHUB_OUTPUT
              echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT
              
              echo "✅ Parsed Claude Code execution results:"
            else
              echo "❌ No result found in execution file"
              echo "conclusion=failure" >> $GITHUB_OUTPUT
              echo "duration_ms=0" >> $GITHUB_OUTPUT
              echo "input_tokens=0" >> $GITHUB_OUTPUT
              echo "output_tokens=0" >> $GITHUB_OUTPUT
              echo "total_cost=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "❌ Execution file not found: $EXECUTION_FILE"
            echo "conclusion=failure" >> $GITHUB_OUTPUT
            echo "duration_ms=0" >> $GITHUB_OUTPUT
            echo "input_tokens=0" >> $GITHUB_OUTPUT
            echo "output_tokens=0" >> $GITHUB_OUTPUT
            echo "total_cost=0" >> $GITHUB_OUTPUT
          fi

      - name: Create Claude Code Execution Entity in Port
        if: ${{ inputs.run_id != '' }}
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.port.io
          operation: UPSERT
          identifier: "claude-exec-${{ inputs.run_id }}"
          title: "claude-exec-${{ inputs.run_id }}"
          icon: "Code"
          blueprint: "claudeCodeExecution"
          properties: |-
            {
              "prompt": ${{ toJSON(inputs.command) }},
              "status": "${{ steps.parse_results.outputs.conclusion == 'success' && 'success' || 'failed' }}",
              "executionTime": ${{ steps.parse_results.outputs.duration_ms }},
              "claudeResponse": ${{ toJSON(steps.parse_results.outputs.claude_response) }},
              "inputTokens": ${{ steps.parse_results.outputs.input_tokens }},
              "outputTokens": ${{ steps.parse_results.outputs.output_tokens }},
              "totalCost": ${{ steps.parse_results.outputs.total_cost }},
              "repository": "${{ inputs.repo_name }}"
            }
          relations: |
            {
              "ai_coding_agent": "Claude",
              "repository": "${{ inputs.repo_name }}"
            }
      - name: Update Port Action Run Status to Success
        if: ${{ inputs.run_id != '' && steps.parse_results.outputs.conclusion == 'success' }}
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.port.io
          operation: PATCH_RUN
          runId: ${{ inputs.run_id }}
          status: "SUCCESS"
          logMessage: |
            ✅ Claude Code execution completed successfully!
            
            **Execution Summary:**
            - Duration: ${{ steps.parse_results.outputs.duration_ms }}ms
            - Input tokens: ${{ steps.parse_results.outputs.input_tokens }}
            - Output tokens: ${{ steps.parse_results.outputs.output_tokens }}
            - Total cost: ${{ steps.parse_results.outputs.total_cost }}
            - Session ID: ${{ steps.parse_results.outputs.session_id }}
      
      - name: Update Port Action Run Status to Failed
        if: ${{ inputs.run_id != '' && steps.parse_results.outputs.conclusion != 'success' }}
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.port.io
          operation: PATCH_RUN
          runId: ${{ inputs.run_id }}
          status: "FAILURE"
          logMessage: |
            ❌ Claude Code execution failed. Check GitHub Actions logs for details!
            
            **Execution Summary:**
            - Duration: ${{ steps.parse_results.outputs.duration_ms }}ms
            - Input tokens: ${{ steps.parse_results.outputs.input_tokens }}
            - Output tokens: ${{ steps.parse_results.outputs.output_tokens }}
            - Total cost: ${{ steps.parse_results.outputs.total_cost }}
            - Session ID: ${{ steps.parse_results.outputs.session_id }}
